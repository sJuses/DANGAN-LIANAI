<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>å¿ƒåŠ¨æ¡£æ¡ˆ</title>
    <style>
        :root {
            --primary-color: #ff758c;
            --food-tag: #ff9f43;
            --avoid-tag: #48dbfb;
            --like-tag: #a29bfe;
            --dislike-tag: #ff6b6b;
            --bg-grad-1: #ffdeef;
            --bg-grad-2: #feeeff;
            --card-bg: rgba(255, 255, 255, 0.82);
            --text-main: #4a4a4a;
        }

        body {
            font-family: -apple-system, "SF Pro Text", "PingFang SC", sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
            margin: 0; padding: env(safe-area-inset-top) 20px 140px 20px;
            color: var(--text-main); min-height: 100vh;
        }

        #bg-canvas, #confetti-canvas { position: fixed; top: 0; left: 0; z-index: -1; pointer-events: none; }
        #confetti-canvas { z-index: 1001; }

        header { text-align: center; padding: 20px 0; }
        header h1 { font-size: 24px; letter-spacing: 4px; color: var(--primary-color); margin: 10px 0; }
        
        .status-banner {
            font-size: 11px; color: var(--primary-color);
            background: rgba(255,255,255,0.7); padding: 6px 16px;
            border-radius: 20px; display: inline-block; margin-bottom: 5px;
        }

        .tag-container {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 12px;
            background: rgba(255,255,255,0.4); border-radius: 18px; min-height: 48px;
            border: 1px solid rgba(255, 255, 255, 0.5); margin-bottom: 10px;
        }
        .tag {
            color: white; padding: 6px 14px; border-radius: 50px; font-size: 13px;
            display: flex; align-items: center; animation: tagFloat 4s ease-in-out infinite alternate;
        }
        .tag-food { background: var(--food-tag); }
        .tag-avoid { background: var(--avoid-tag); }
        .tag-like { background: var(--like-tag); }
        .tag-dislike { background: var(--dislike-tag); }
        .tag .remove { margin-left: 6px; cursor: pointer; font-weight: bold; }
        @keyframes tagFloat { 0% { transform: translateY(0); } 100% { transform: translateY(-3px); } }

        .tag-input { border: none !important; background: transparent !important; padding: 5px !important; flex-grow: 1; outline: none; }

        .avatar-wrapper {
            width: 100px; height: 100px; border-radius: 30px; border: 4px solid #fff;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); overflow: hidden; margin: 0 auto 15px;
        }
        .avatar-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        .card {
            background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 32px; padding: 24px; margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03); border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .card-title { font-size: 18px; font-weight: 700; color: var(--primary-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #aaa; margin: 5px 0 5px 4px; letter-spacing: 0.5px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, textarea {
            width: 100%; border: 1px solid rgba(0,0,0,0.03); background: rgba(255,255,255,0.5);
            border-radius: 16px; padding: 12px; font-size: 15px; box-sizing: border-box; outline: none;
        }

        .item-row { 
            background: rgba(255,255,255,0.5); padding: 16px; border-radius: 20px; 
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.6); position: relative;
        }
        .img-preview {
            width: 100%; max-height: 180px; object-fit: cover; border-radius: 14px;
            margin: 10px 0; display: none; border: 2px solid white;
        }
        .photo-btn { font-size: 12px; color: var(--primary-color); background: #fff; padding: 6px 12px; border-radius: 12px; border: 1px solid var(--primary-color); margin-top: 5px; display: inline-block; cursor: pointer; }
        .del-btn { color: #ccc; font-size: 11px; position: absolute; top: 15px; right: 15px; cursor: pointer; }

        .footer-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 20px 25px calc(25px + env(safe-area-inset-bottom));
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); z-index: 1000;
        }
        .btn-save {
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
            color: white; border: none; width: 100%; padding: 18px; border-radius: 22px; 
            font-size: 17px; font-weight: 700; box-shadow: 0 10px 25px rgba(255, 117, 140, 0.3);
        }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <canvas id="confetti-canvas"></canvas>

    <header>
        <div id="love-days" class="status-banner">â¤ å¼€å¯æ‹çˆ±è®¡æ—¶</div><br>
        <div id="bday-countdown" class="status-banner">ğŸ‚ å¼€å¯ç”Ÿæ—¥å€’è®¡æ—¶</div>
        <h1>å¿ƒåŠ¨æ¡£æ¡ˆ</h1>
    </header>

    <div class="card">
        <div class="card-title">ğŸŒ¸ åŸºç¡€èµ„æ–™</div>
        <div class="avatar-wrapper" onclick="document.getElementById('file-input').click()">
            <img id="avatar-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ff758c' d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E">
        </div>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleMainAvatar(this)">
        
        <div class="input-group"><label>å§“å/æ˜µç§°</label><input type="text" id="nickname"></div>
        <div class="grid-2">
            <div class="input-group"><label>èº«é«˜ (cm)</label><input type="number" id="height"></div>
            <div class="input-group"><label>ä½“é‡ (kg)</label><input type="number" id="weight"></div>
        </div>
        <div class="input-group"><label>è”ç³»ç”µè¯</label><input type="tel" id="phone"></div>
        <div class="input-group"><label>åœ¨ä¸€èµ·çš„æ—¥æœŸ</label><input type="date" id="love_start_date" onchange="updateUI()"></div>
        <div class="input-group"><label>ç”Ÿæ—¥</label><input type="date" id="birthday" onchange="updateUI()"></div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ¥¡ å¤–å–åœ°å€ <span style="cursor:pointer" onclick="addAddress('takeout-list', 'å¤–å–åœ°å€')">+</span></div>
        <div id="takeout-list"></div>
        
        <div class="card-title" style="margin-top:25px">ğŸ“¦ å¿«é€’åœ°å€ <span style="cursor:pointer" onclick="addAddress('delivery-list', 'å¿«é€’åœ°å€')">+</span></div>
        <div id="delivery-list"></div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ¾ èŒå® æ¡£æ¡ˆ <span style="cursor:pointer" onclick="addPet()">+</span></div>
        <div id="pet-list"></div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ² èˆŒå°–åå¥½</div>
        <label>å–œæ¬¢çš„é£Ÿç‰©</label>
        <div class="tag-container" id="tags-food-likes" data-type="tag-food">
            <input type="text" class="tag-input" placeholder="è¾“å…¥å¹¶å›è½¦">
        </div>
        <label>å¿Œå£</label>
        <div class="tag-container" id="tags-food-avoid" data-type="tag-avoid">
            <input type="text" class="tag-input" placeholder="è¾“å…¥å¹¶å›è½¦">
        </div>
    </div>

    <div class="card">
        <div class="card-title">âœ¨ å¥¹çš„å¿ƒå¤´å¥½</div>
        <div class="tag-container" id="tags-general-likes" data-type="tag-like">
            <input type="text" class="tag-input" placeholder="è¾“å…¥å¹¶å›è½¦">
        </div>
        <div class="card-title" style="margin-top:20px; color:var(--dislike-tag)">ğŸš« ç»å¯¹é›·åŒº</div>
        <div class="tag-container" id="tags-general-dislikes" data-type="tag-dislike">
            <input type="text" class="tag-input" placeholder="è¾“å…¥å¹¶å›è½¦">
        </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ å¥¹çš„å¿ƒæ„¿å• <span style="cursor:pointer" onclick="addItem('wish-list')">+</span></div>
        <div id="wish-list"></div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ“… çºªå¿µæ—¶åˆ» <span style="cursor:pointer" onclick="addItem('anni-list')">+</span></div>
        <div id="anni-list"></div>
    </div>

    <div class="footer-bar">
        <button class="btn-save" onclick="handleSave()">åŒæ­¥è‡³æ‰‹æœº âœ¨</button>
    </div>

    <script>
        // --- å›¾ç‰‡å‹ç¼©é€»è¾‘ ---
        async function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
            });
        }

        const STORAGE_KEY = 'love_v15_her'; // æ›´æ”¹ key ä»¥åˆ·æ–°æ€§åˆ«æŒ‡ä»£
        let currentAvatar = "";

        async function handleMainAvatar(input) {
            if (input.files[0]) {
                currentAvatar = await compressImage(input.files[0], 400, 0.8);
                document.getElementById('avatar-img').src = currentAvatar;
            }
        }

        async function handleRowFile(input, imgId) {
            if (input.files[0]) {
                const compressed = await compressImage(input.files[0], 800, 0.7);
                const img = document.getElementById(imgId);
                img.src = compressed; img.style.display = 'block';
            }
        }

        // --- åŠ¨æ€å® ç‰©æ¨¡å— ---
        function addPet(name="", type="", date="", imgData="") {
            const container = document.getElementById('pet-list');
            const div = document.createElement('div');
            div.className = 'item-row';
            const rowId = 'pet-' + Math.random().toString(16).slice(2, 10);
            div.innerHTML = `
                <div class="grid-2" style="margin-bottom:8px">
                    <input type="text" placeholder="å® ç‰©æ˜µç§°" value="${name}" style="font-weight:600">
                    <input type="text" placeholder="å“ç§" value="${type}">
                </div>
                <input type="date" placeholder="ç”Ÿæ—¥/åˆ°å®¶æ—¥" value="${date}" style="font-size:13px; color:var(--primary-color); background:none; border:none; margin-bottom:5px">
                <img id="${rowId}-img" class="img-preview" src="${imgData}" style="${imgData?'display:block':''}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px">
                    <label class="photo-btn" onclick="document.getElementById('${rowId}-file').click()">ğŸ“¸ å® ç‰©ç…§ç‰‡</label>
                    <input type="file" id="${rowId}-file" accept="image/*" style="display:none" onchange="handleRowFile(this, '${rowId}-img')">
                </div>
                <span class="del-btn" onclick="this.parentElement.remove()">åˆ é™¤</span>
            `;
            container.appendChild(div);
        }

        // --- åœ°å€æ·»åŠ é€»è¾‘ ---
        function addAddress(containerId, placeholder, content = "") {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <textarea placeholder="${placeholder}" rows="2" style="background:none; border:none; padding:0">${content}</textarea>
                <span class="del-btn" onclick="this.parentElement.remove()">åˆ é™¤</span>
            `;
            container.appendChild(div);
        }

        // --- è®°å½•åˆ—è¡¨ ---
        function addItem(containerId, title = "", desc = "", imgData = "") {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'item-row';
            const rowId = 'row-' + Math.random().toString(16).slice(2, 10);
            div.innerHTML = `
                <input type="text" placeholder="æ ‡é¢˜" value="${title}" style="margin-bottom:8px; font-weight:600">
                <input type="${containerId==='anni-list'?'date':'text'}" placeholder="å…·ä½“æ—¥æœŸ/å¤‡æ³¨" value="${desc}" style="font-size:13px; color:var(--primary-color); background:none; border:none">
                <img id="${rowId}-img" class="img-preview" src="${imgData}" style="${imgData?'display:block':''}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px">
                    <label class="photo-btn" onclick="document.getElementById('${rowId}-file').click()">ğŸ–¼ï¸ ç…§ç‰‡</label>
                    <input type="file" id="${rowId}-file" accept="image/*" style="display:none" onchange="handleRowFile(this, '${rowId}-img')">
                </div>
                <span class="del-btn" onclick="this.closest('.item-row').remove()">åˆ é™¤</span>
            `;
            container.appendChild(div);
        }

        // --- æ ‡ç­¾ç³»ç»Ÿ ---
        function initTagSystem(containerId) {
            const container = document.getElementById(containerId);
            const input = container.querySelector('.tag-input');
            const addTag = (text) => {
                if (!text.trim()) return;
                const tag = document.createElement('div');
                tag.className = `tag ${container.dataset.type}`;
                tag.innerHTML = `${text}<span class="remove">Ã—</span>`;
                tag.querySelector('.remove').onclick = () => tag.remove();
                container.insertBefore(tag, input);
                input.value = '';
            };
            input.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); addTag(input.value); } };
        }
        ['tags-food-likes', 'tags-food-avoid', 'tags-general-likes', 'tags-general-dislikes'].forEach(initTagSystem);

        function updateUI() {
            const loveDate = document.getElementById('love_start_date').value;
            if(loveDate) {
                const diff = Math.floor((new Date() - new Date(loveDate)) / (1000*60*60*24));
                document.getElementById('love-days').innerText = `â¤ æˆ‘ä»¬å·²ç»åœ¨ä¸€èµ· ${diff} å¤©äº†`;
            }
            const bday = document.getElementById('birthday').value;
            if(bday) {
                const now = new Date(); const bd = new Date(bday);
                let next = new Date(now.getFullYear(), bd.getMonth(), bd.getDate());
                if(now > next) next.setFullYear(now.getFullYear()+1);
                const diff = Math.ceil((next - now)/(1000*60*60*24));
                document.getElementById('bday-countdown').innerText = `ğŸ‚ è·ç¦»ä¸‹ä¸ªç”Ÿæ—¥è¿˜æœ‰ ${diff} å¤©`;
            }
        }

        function handleSave() {
            const getTags = (id) => Array.from(document.getElementById(id).querySelectorAll('.tag')).map(t => t.innerText.replace('Ã—', ''));
            const getSimpleList = (id) => Array.from(document.getElementById(id).querySelectorAll('textarea')).map(t => t.value);
            const getPetList = () => Array.from(document.getElementById('pet-list').children).map(row => ({
                n: row.querySelectorAll('input')[0].value, t: row.querySelectorAll('input')[1].value, 
                d: row.querySelectorAll('input')[2].value, i: row.querySelector('img').src.startsWith('data') ? row.querySelector('img').src : ""
            }));
            const getFullList = (id) => Array.from(document.getElementById(id).children).map(row => ({
                t: row.querySelectorAll('input')[0].value, d: row.querySelectorAll('input')[1].value,
                i: row.querySelector('img').src.startsWith('data') ? row.querySelector('img').src : ""
            }));

            const data = {
                avatar: currentAvatar, nickname: document.getElementById('nickname').value,
                height: document.getElementById('height').value, weight: document.getElementById('weight').value,
                phone: document.getElementById('phone').value, loveDate: document.getElementById('love_start_date').value,
                birthday: document.getElementById('birthday').value, takeout: getSimpleList('takeout-list'),
                delivery: getSimpleList('delivery-list'), pets: getPetList(),
                foodLikes: getTags('tags-food-likes'), foodAvoid: getTags('tags-food-avoid'),
                generalLikes: getTags('tags-general-likes'), generalDislikes: getTags('tags-general-dislikes'),
                wishes: getFullList('wish-list'), annis: getFullList('anni-list')
            };
            
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); startConfetti(); } 
            catch(e) { alert("å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè¯·æ¸…ç†ä¸€äº›ç…§ç‰‡"); }
        }

        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                const d = JSON.parse(saved);
                document.getElementById('nickname').value = d.nickname || '';
                document.getElementById('height').value = d.height || '';
                document.getElementById('weight').value = d.weight || '';
                document.getElementById('phone').value = d.phone || '';
                document.getElementById('love_start_date').value = d.loveDate || '';
                document.getElementById('birthday').value = d.birthday || '';
                if(d.avatar) { currentAvatar = d.avatar; document.getElementById('avatar-img').src = d.avatar; }
                const setTags = (id, tags) => {
                    const c = document.getElementById(id); if(!c) return;
                    const input = c.querySelector('.tag-input');
                    tags.forEach(t => {
                        const tag = document.createElement('div'); tag.className = `tag ${c.dataset.type}`;
                        tag.innerHTML = `${t}<span class="remove">Ã—</span>`;
                        tag.querySelector('.remove').onclick = () => tag.remove();
                        c.insertBefore(tag, input);
                    });
                };
                setTags('tags-food-likes', d.foodLikes || []); setTags('tags-food-avoid', d.foodAvoid || []);
                setTags('tags-general-likes', d.generalLikes || []); setTags('tags-general-dislikes', d.generalDislikes || []);
                if(d.takeout) d.takeout.forEach(a => addAddress('takeout-list', 'å¤–å–åœ°å€', a));
                if(d.delivery) d.delivery.forEach(a => addAddress('delivery-list', 'å¿«é€’åœ°å€', a));
                if(d.pets) d.pets.forEach(p => addPet(p.n, p.t, p.d, p.i));
                if(d.wishes) d.wishes.forEach(w => addItem('wish-list', w.t, w.d, w.i));
                if(d.annis) d.annis.forEach(a => addItem('anni-list', a.t, a.d, a.i));
                updateUI();
            }
        };

        // --- ç‰¹æ•ˆé€»è¾‘ ---
        const confCanvas = document.getElementById('confetti-canvas');
        const cfx = confCanvas.getContext('2d');
        let confettis = [];
        function startConfetti() {
            confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight;
            confettis = Array.from({length: 60}, () => ({
                x: window.innerWidth/2, y: window.innerHeight*0.4,
                v: { x: (Math.random()-0.5)*10, y: (Math.random()-0.5)*10 - 5 },
                c: `hsl(${Math.random()*360}, 100%, 75%)`, s: Math.random()*6+4, a: 1
            }));
            animateConf();
        }
        function animateConf() {
            cfx.clearRect(0,0,confCanvas.width,confCanvas.height);
            confettis.forEach((p, i) => {
                p.x += p.v.x; p.y += p.v.y; p.v.y += 0.25; p.a -= 0.015;
                cfx.globalAlpha = p.a; cfx.fillStyle = p.c;
                cfx.fillRect(p.x, p.y, p.s, p.s);
                if(p.a <= 0) confettis.splice(i, 1);
            });
            if(confettis.length > 0) requestAnimationFrame(animateConf);
        }

        const canvas = document.getElementById('bg-canvas'); const ctx = canvas.getContext('2d');
        let ps = [];
        function initBg() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            ps = Array.from({length:30}, () => ({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*12+12, v:Math.random()*0.15+0.1}));
        }
        function drawBg() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "rgba(255,117,140,0.15)";
            ps.forEach(p => { ctx.font="16px serif"; ctx.fillText("æ¬£", p.x, p.y); p.y+=p.v; if(p.y>canvas.height) p.y=-20; });
            requestAnimationFrame(drawBg);
        }
        initBg(); drawBg();
    </script>
</body>
</html>
